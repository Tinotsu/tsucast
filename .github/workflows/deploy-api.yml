name: Deploy API

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'packages/**'
  workflow_dispatch:

concurrency:
  group: deploy-api
  cancel-in-progress: true

jobs:
  smoke-test:
    name: Post-Deploy Smoke Test
    runs-on: ubuntu-latest
    # Railway auto-deploys via GitHub integration on push to main.
    # This workflow only verifies the deploy succeeded.
    # On workflow_dispatch (manual), it smoke-tests the current live deploy.

    steps:
      - name: Wait for Railway deploy
        run: |
          echo "Railway auto-deploys on push. Waiting 90s for build + deploy..."
          sleep 90

      - name: Wait for health check
        run: |
          for i in $(seq 1 24); do
            if curl -sf https://api.tsucast.com/health/ready; then
              echo "Health check passed on attempt $i"
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          echo "Health check failed after 24 attempts (4 minutes)"
          exit 1

      - name: Smoke test
        run: |
          RESPONSE=$(curl -sf https://api.tsucast.com/health) || {
            echo "Smoke test failed: curl could not reach health endpoint"
            exit 1
          }
          echo "$RESPONSE"
          if echo "$RESPONSE" | grep -qE '"status"\s*:\s*"ok"'; then
            echo "Smoke test passed"
          else
            echo "Smoke test failed: health check did not return ok status"
            exit 1
          fi
