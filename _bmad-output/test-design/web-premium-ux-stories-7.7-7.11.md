# Test Design: Web Premium UX (Stories 7.7-7.11)

> Generated by TEA (Test Engineering Architect)
> Date: 2026-01-29
> Scope: Epic 7 - Web Premium UX Features

---

## 1. Overview

This test design covers the new web premium UX features added to Epic 7:

| Story | Feature | Priority |
|-------|---------|----------|
| 7.7 | Global Persistent Audio Player | P0 (Critical) |
| 7.8 | Explore Tab with Free Content | P2 |
| 7.9 | Free Content Admin Management | P3 |
| 7.10 | Embeddable Player for Landing Page | P1 |
| 7.11 | Night Mode Toggle | P3 |

**Total Test Scenarios:** 36
- E2E: 19
- Integration: 10
- Unit: 4
- Manual: 2

---

## 2. Risk Assessment

### Risk Scoring Matrix (Probability × Impact)

| Story | Probability | Impact | Risk Score | Rationale |
|-------|-------------|--------|------------|-----------|
| 7.7 | 3 (High) | 3 (High) | **9** | Complex browser state management, Media Session API, cross-page persistence. Failure breaks all web audio. |
| 7.8 | 1 (Low) | 2 (Med) | 2 | Standard tab UI with API fetch. Depends on 7.7. |
| 7.9 | 1 (Low) | 1 (Low) | 1 | Standard admin CRUD. Low user impact. |
| 7.10 | 1 (Low) | 2 (Med) | 2 | Self-contained component. Critical for conversion funnel. |
| 7.11 | 1 (Low) | 1 (Low) | 1 | Standard theme toggle. UX enhancement only. |

### Priority Classification

- **P0 (Critical):** Story 7.7 - Foundation for all web audio functionality
- **P1 (High):** Story 7.10 - Landing page conversion, first user impression
- **P2 (Medium):** Story 7.8 - Content discovery, requires 7.7
- **P3 (Low):** Stories 7.9, 7.11 - Admin features and UX enhancements

---

## 3. Test Level Selection

| Story | Unit | Integration | E2E | Manual |
|-------|:----:|:-----------:|:---:|:------:|
| 7.7 | ✅ | ✅ | ✅ | ✅ |
| 7.8 | - | ✅ | ✅ | - |
| 7.9 | - | ✅ | ✅ | - |
| 7.10 | - | - | ✅ | - |
| 7.11 | - | ✅ | ✅ | - |

---

## 4. Test Scenarios

### 4.1 Story 7.7: Global Persistent Audio Player (P0)

**FR Mapping:** FR66, FR67, FR68

#### Unit Tests (4 scenarios)

| ID | Scenario | Expected Result |
|----|----------|-----------------|
| 7.7-U1 | `AudioService.getInstance()` called multiple times | Returns same singleton instance |
| 7.7-U2 | `AudioService.play(url)` with valid URL | Sets audio source, begins playback, updates state |
| 7.7-U3 | `AudioService.getState()` during playback | Returns `{ isPlaying: true, currentTime, duration, src }` |
| 7.7-U4 | `AudioService.persistPosition()` called | Writes current position to localStorage with article ID |

**Test File:** `apps/web/__tests__/services/audio-service.test.ts`

```typescript
// Example test structure
describe('AudioService', () => {
  describe('singleton pattern', () => {
    it('returns same instance on multiple getInstance calls', () => {
      const instance1 = AudioService.getInstance();
      const instance2 = AudioService.getInstance();
      expect(instance1).toBe(instance2);
    });
  });

  describe('playback', () => {
    it('sets audio source and begins playback', async () => {
      const service = AudioService.getInstance();
      await service.play('https://example.com/audio.mp3');
      expect(service.getState().src).toBe('https://example.com/audio.mp3');
      expect(service.getState().isPlaying).toBe(true);
    });
  });

  describe('persistence', () => {
    it('saves position to localStorage', () => {
      const service = AudioService.getInstance();
      service.persistPosition('article-123');
      expect(localStorage.getItem('playback-position-article-123')).toBeDefined();
    });
  });
});
```

#### Integration Tests (3 scenarios)

| ID | Scenario | Expected Result |
|----|----------|-----------------|
| 7.7-I1 | AudioPlayerProvider wraps app | Children receive audio state via context |
| 7.7-I2 | Page reload with saved position | Position restored from localStorage |
| 7.7-I3 | Track change updates Media Session | Browser shows correct title/artist in media controls |

**Test File:** `apps/web/__tests__/providers/audio-player-provider.test.tsx`

```typescript
// Example test structure
describe('AudioPlayerProvider', () => {
  it('provides audio state to children', () => {
    render(
      <AudioPlayerProvider>
        <TestConsumer />
      </AudioPlayerProvider>
    );
    expect(screen.getByTestId('audio-state')).toHaveTextContent('ready');
  });

  it('restores position from localStorage on mount', async () => {
    localStorage.setItem('playback-position-article-123', JSON.stringify({ time: 45.5 }));
    render(<AudioPlayerProvider><TestConsumer /></AudioPlayerProvider>);
    // Verify position restored
  });
});
```

#### E2E Tests (5 scenarios)

| ID | Scenario | Steps | Expected Result |
|----|----------|-------|-----------------|
| 7.7-E1 | Audio persists across navigation | 1. Login, 2. Play audio in Library, 3. Navigate to Settings, 4. Navigate back to Library | Audio continues playing, position unchanged |
| 7.7-E2 | Audio persists across tab switch | 1. Play audio, 2. Open new browser tab, 3. Wait 10s, 4. Return to tsucast tab | Audio still playing at expected position |
| 7.7-E3 | Mini-player shows on all pages | 1. Start playback, 2. Navigate: Library → Add → Settings → Library | Mini-player visible on each page |
| 7.7-E4 | Mini-player controls work | 1. Start playback, 2. Click pause on mini-player, 3. Click play | Playback pauses/resumes without opening full player |
| 7.7-E5 | Browser tab shows playing indicator | 1. Start playback, 2. Observe browser tab | Tab title includes "▶" or "Playing" indicator |

**Test File:** `apps/web/e2e/audio-player.spec.ts`

```typescript
// Example Playwright test structure
test.describe('Global Persistent Audio Player', () => {
  test('audio continues when navigating between pages', async ({ page }) => {
    await page.goto('/library');
    await page.click('[data-testid="play-button-0"]');

    // Get current time
    const initialTime = await page.evaluate(() =>
      window.__audioService?.getState().currentTime
    );

    // Navigate away
    await page.click('[data-testid="nav-settings"]');
    await page.waitForURL('/settings');

    // Navigate back
    await page.click('[data-testid="nav-library"]');
    await page.waitForURL('/library');

    // Verify still playing
    const finalTime = await page.evaluate(() =>
      window.__audioService?.getState().currentTime
    );

    expect(finalTime).toBeGreaterThan(initialTime);
  });

  test('mini-player appears on all pages during playback', async ({ page }) => {
    await page.goto('/library');
    await page.click('[data-testid="play-button-0"]');

    const pages = ['/add', '/settings', '/library'];
    for (const path of pages) {
      await page.goto(path);
      await expect(page.locator('[data-testid="mini-player"]')).toBeVisible();
    }
  });
});
```

#### Manual Tests (2 scenarios)

| ID | Scenario | Steps | Expected Result |
|----|----------|-------|-----------------|
| 7.7-M1 | Audio continues on lock screen (mobile) | 1. Open tsucast in mobile Safari/Chrome, 2. Start audio playback, 3. Lock phone screen | Audio continues playing |
| 7.7-M2 | Lock screen controls work | 1. Play audio, 2. Lock screen, 3. Use lock screen play/pause | Controls toggle playback |

**Manual Test Checklist:**
- [ ] iOS Safari: Audio continues on lock
- [ ] iOS Safari: Lock screen controls work
- [ ] Android Chrome: Audio continues on lock
- [ ] Android Chrome: Lock screen controls work

---

### 4.2 Story 7.8: Explore Tab with Free Content (P2)

**FR Mapping:** FR63

#### Integration Tests (2 scenarios)

| ID | Scenario | Expected Result |
|----|----------|-----------------|
| 7.8-I1 | `GET /api/free-content` returns grouped content | Response includes `featured`, `popular`, `new` categories |
| 7.8-I2 | Free content items include audio URLs | Each item has valid `audio_url` from audio_cache |

**Test File:** `apps/web/__tests__/api/free-content.test.ts`

```typescript
describe('GET /api/free-content', () => {
  it('returns content grouped by category', async () => {
    const response = await fetch('/api/free-content');
    const data = await response.json();

    expect(data.featured).toBeDefined();
    expect(data.popular).toBeDefined();
    expect(data.new).toBeDefined();
  });

  it('items include audio_url', async () => {
    const response = await fetch('/api/free-content');
    const data = await response.json();

    data.featured.forEach(item => {
      expect(item.audio_url).toMatch(/^https:\/\//);
    });
  });
});
```

#### E2E Tests (4 scenarios)

| ID | Scenario | Steps | Expected Result |
|----|----------|-------|-----------------|
| 7.8-E1 | Library shows three tabs | 1. Navigate to Library | Tabs visible: All / Playlists / Explore |
| 7.8-E2 | Explore tab displays content | 1. Click Explore tab | Content displayed with title, description, play button |
| 7.8-E3 | Unauthenticated can access Explore | 1. Logout, 2. Navigate to /library, 3. Click Explore | Content visible, playable |
| 7.8-E4 | Playing Explore item uses global player | 1. Click play on Explore item | Mini-player appears, audio plays |

**Test File:** `apps/web/e2e/explore-tab.spec.ts`

```typescript
test.describe('Explore Tab', () => {
  test('library page shows three tabs', async ({ page }) => {
    await page.goto('/library');
    await expect(page.getByRole('tab', { name: 'All' })).toBeVisible();
    await expect(page.getByRole('tab', { name: 'Playlists' })).toBeVisible();
    await expect(page.getByRole('tab', { name: 'Explore' })).toBeVisible();
  });

  test('unauthenticated user can view and play Explore content', async ({ page }) => {
    // Clear auth
    await page.context().clearCookies();

    await page.goto('/library');
    await page.click('[data-testid="tab-explore"]');

    // Verify content visible
    await expect(page.locator('[data-testid="explore-item"]').first()).toBeVisible();

    // Play without auth
    await page.click('[data-testid="explore-play-0"]');
    await expect(page.locator('[data-testid="mini-player"]')).toBeVisible();
  });
});
```

---

### 4.3 Story 7.9: Free Content Admin Management (P3)

**FR Mapping:** FR63 (admin side)

#### Integration Tests (3 scenarios)

| ID | Scenario | Expected Result |
|----|----------|-----------------|
| 7.9-I1 | `POST /api/admin/free-content` | Creates new free content item |
| 7.9-I2 | `PUT /api/admin/free-content/:id` | Updates existing item |
| 7.9-I3 | `DELETE /api/admin/free-content/:id` | Removes item, audio_cache unchanged |

**Test File:** `apps/web/__tests__/api/admin/free-content.test.ts`

```typescript
describe('Admin Free Content API', () => {
  const adminToken = 'test-admin-token';

  it('creates free content item', async () => {
    const response = await fetch('/api/admin/free-content', {
      method: 'POST',
      headers: { Authorization: `Bearer ${adminToken}` },
      body: JSON.stringify({
        audio_cache_id: 'uuid-123',
        title: 'Sample Article',
        description: 'A great article',
        category: 'featured',
        position: 1
      })
    });

    expect(response.status).toBe(201);
  });

  it('deletes item without affecting audio_cache', async () => {
    const response = await fetch('/api/admin/free-content/item-id', {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${adminToken}` }
    });

    expect(response.status).toBe(200);
    // Verify audio_cache still exists
  });
});
```

#### E2E Tests (3 scenarios)

| ID | Scenario | Steps | Expected Result |
|----|----------|-------|-----------------|
| 7.9-E1 | Admin views free content list | 1. Login as admin, 2. Navigate to /admin/free-content | List displayed with filter options |
| 7.9-E2 | Admin CRUD operations | 1. Add content, 2. Edit content, 3. Delete content | All operations succeed |
| 7.9-E3 | Non-admin access blocked | 1. Login as regular user, 2. Navigate to /admin/free-content | 403 Forbidden |

**Test File:** `apps/web/e2e/admin/free-content.spec.ts`

```typescript
test.describe('Admin Free Content Management', () => {
  test('non-admin cannot access', async ({ page }) => {
    await loginAsUser(page, 'regular-user@test.com');
    await page.goto('/admin/free-content');
    await expect(page).toHaveURL('/dashboard'); // Redirected
  });

  test('admin can add, edit, delete content', async ({ page }) => {
    await loginAsAdmin(page);
    await page.goto('/admin/free-content');

    // Add
    await page.click('[data-testid="add-content"]');
    await page.fill('[data-testid="title-input"]', 'Test Content');
    await page.click('[data-testid="save-button"]');
    await expect(page.getByText('Test Content')).toBeVisible();

    // Edit
    await page.click('[data-testid="edit-0"]');
    await page.fill('[data-testid="title-input"]', 'Updated Content');
    await page.click('[data-testid="save-button"]');
    await expect(page.getByText('Updated Content')).toBeVisible();

    // Delete
    await page.click('[data-testid="delete-0"]');
    await page.click('[data-testid="confirm-delete"]');
    await expect(page.getByText('Updated Content')).not.toBeVisible();
  });
});
```

---

### 4.4 Story 7.10: Embeddable Player for Landing Page (P1)

**FR Mapping:** FR65

#### E2E Tests (5 scenarios)

| ID | Scenario | Steps | Expected Result |
|----|----------|-------|-----------------|
| 7.10-E1 | Player visible on landing | 1. Navigate to / (landing page) | Embeddable player is visible |
| 7.10-E2 | Audio plays without auth | 1. Clear cookies, 2. Click play on landing player | Audio plays |
| 7.10-E3 | Controls work | 1. Play audio, 2. Test pause/seek/volume | All controls functional |
| 7.10-E4 | CTA visible | 1. View landing page | "Sign up" CTA visible near player |
| 7.10-E5 | Audio stops on navigation | 1. Play audio, 2. Click "Get Started" | Audio stops when leaving landing |

**Test File:** `apps/web/e2e/landing-player.spec.ts`

```typescript
test.describe('Embeddable Player - Landing Page', () => {
  test('player displays and plays without authentication', async ({ page }) => {
    await page.context().clearCookies();
    await page.goto('/');

    await expect(page.locator('[data-testid="landing-player"]')).toBeVisible();

    await page.click('[data-testid="landing-player-play"]');

    // Verify audio is playing
    const isPlaying = await page.evaluate(() => {
      const audio = document.querySelector('[data-testid="landing-audio"]');
      return audio && !audio.paused;
    });
    expect(isPlaying).toBe(true);
  });

  test('audio stops when navigating away from landing', async ({ page }) => {
    await page.goto('/');
    await page.click('[data-testid="landing-player-play"]');

    // Navigate to signup
    await page.click('[data-testid="cta-signup"]');
    await page.waitForURL('/auth/register');

    // Verify audio stopped
    const isPlaying = await page.evaluate(() => {
      const audio = document.querySelector('[data-testid="landing-audio"]');
      return audio && !audio.paused;
    });
    expect(isPlaying).toBeFalsy();
  });

  test('player controls work', async ({ page }) => {
    await page.goto('/');
    const player = page.locator('[data-testid="landing-player"]');

    // Play
    await player.locator('[data-testid="play-button"]').click();
    await expect(player.locator('[data-testid="pause-button"]')).toBeVisible();

    // Pause
    await player.locator('[data-testid="pause-button"]').click();
    await expect(player.locator('[data-testid="play-button"]')).toBeVisible();

    // Volume
    await player.locator('[data-testid="volume-slider"]').fill('50');
  });
});
```

---

### 4.5 Story 7.11: Night Mode Toggle (P3)

**FR Mapping:** FR64

#### Integration Tests (2 scenarios)

| ID | Scenario | Expected Result |
|----|----------|-----------------|
| 7.11-I1 | Logged in user theme saves to DB | `user_profiles.theme` updated |
| 7.11-I2 | Anonymous user theme saves to localStorage | `localStorage.theme` set |

**Test File:** `apps/web/__tests__/hooks/use-theme.test.ts`

```typescript
describe('useTheme', () => {
  it('saves to user_profiles when logged in', async () => {
    const { result } = renderHook(() => useTheme(), {
      wrapper: AuthenticatedWrapper
    });

    await act(() => result.current.setTheme('dark'));

    // Verify API called
    expect(mockUpdateProfile).toHaveBeenCalledWith({ theme: 'dark' });
  });

  it('saves to localStorage when logged out', async () => {
    const { result } = renderHook(() => useTheme(), {
      wrapper: UnauthenticatedWrapper
    });

    await act(() => result.current.setTheme('dark'));

    expect(localStorage.getItem('theme')).toBe('dark');
  });
});
```

#### E2E Tests (3 scenarios)

| ID | Scenario | Steps | Expected Result |
|----|----------|-------|-----------------|
| 7.11-E1 | Theme options visible | 1. Navigate to Settings | Light / Dark / System options shown |
| 7.11-E2 | Theme changes immediately | 1. Select Dark | Background changes to #121212 immediately |
| 7.11-E3 | System follows device | 1. Select System, 2. Change device to dark mode | Theme follows device |

**Test File:** `apps/web/e2e/theme-toggle.spec.ts`

```typescript
test.describe('Night Mode Toggle', () => {
  test('settings page shows theme options', async ({ page }) => {
    await page.goto('/settings');

    await expect(page.getByRole('radio', { name: 'Light' })).toBeVisible();
    await expect(page.getByRole('radio', { name: 'Dark' })).toBeVisible();
    await expect(page.getByRole('radio', { name: 'System' })).toBeVisible();
  });

  test('theme changes immediately on selection', async ({ page }) => {
    await page.goto('/settings');

    // Select Dark
    await page.click('[data-testid="theme-dark"]');

    // Verify background color
    const bgColor = await page.evaluate(() =>
      getComputedStyle(document.body).backgroundColor
    );
    expect(bgColor).toBe('rgb(18, 18, 18)'); // #121212
  });

  test('system option follows device preference', async ({ page }) => {
    // Emulate dark mode
    await page.emulateMedia({ colorScheme: 'dark' });
    await page.goto('/settings');

    await page.click('[data-testid="theme-system"]');

    const bgColor = await page.evaluate(() =>
      getComputedStyle(document.body).backgroundColor
    );
    expect(bgColor).toBe('rgb(18, 18, 18)');

    // Switch to light
    await page.emulateMedia({ colorScheme: 'light' });
    await page.waitForTimeout(100); // Allow transition

    const lightBg = await page.evaluate(() =>
      getComputedStyle(document.body).backgroundColor
    );
    expect(lightBg).toBe('rgb(255, 255, 255)');
  });
});
```

---

## 5. Implementation Order

| Order | Story | Priority | Dependencies | Rationale |
|-------|-------|----------|--------------|-----------|
| 1 | 7.7 | P0 | None | Foundation - all web audio depends on this |
| 2 | 7.9 | P3 | Admin panel (7.5) | Needed to populate Explore tab |
| 3 | 7.10 | P1 | None | Landing page conversion, parallel to 7.9 |
| 4 | 7.8 | P2 | 7.7, 7.9 | Depends on global player + admin content |
| 5 | 7.11 | P3 | None | Independent, lowest priority |

---

## 6. Test Data Requirements

### Free Content Test Data

```sql
-- Test data for E2E tests
INSERT INTO free_content (id, audio_cache_id, title, description, category, position, is_active) VALUES
  ('fc-1', 'ac-1', 'Welcome to tsucast', 'Learn how to use the app', 'featured', 1, true),
  ('fc-2', 'ac-2', 'Tech News Daily', 'Latest technology updates', 'featured', 2, true),
  ('fc-3', 'ac-3', 'Science Weekly', 'Fascinating science stories', 'popular', 1, true),
  ('fc-4', 'ac-4', 'History Corner', 'Tales from the past', 'new', 1, true);
```

### Test Users

| Role | Email | Purpose |
|------|-------|---------|
| Admin | admin@test.com | Admin panel tests (7.9) |
| Pro User | pro@test.com | Full feature access |
| Free User | free@test.com | Limit testing |
| Anonymous | - | Unauthenticated flows (7.8, 7.10) |

---

## 7. Quality Gates

### Before Story Completion

- [ ] All P0 E2E tests pass
- [ ] All P1 E2E tests pass
- [ ] Unit test coverage ≥ 80% for new code
- [ ] No console errors in browser
- [ ] Manual lock screen tests pass (7.7 only)

### Before Epic 7 Closure

- [ ] All 36 test scenarios pass
- [ ] Cross-browser testing: Chrome, Firefox, Safari
- [ ] Mobile web testing: iOS Safari, Android Chrome
- [ ] Performance: Audio starts within 2 seconds

---

## 8. Appendix: Test File Structure

```
apps/web/
├── __tests__/
│   ├── services/
│   │   └── audio-service.test.ts      # 7.7 unit tests
│   ├── providers/
│   │   └── audio-player-provider.test.tsx  # 7.7 integration
│   ├── hooks/
│   │   └── use-theme.test.ts          # 7.11 integration
│   └── api/
│       ├── free-content.test.ts       # 7.8 integration
│       └── admin/
│           └── free-content.test.ts   # 7.9 integration
├── e2e/
│   ├── audio-player.spec.ts           # 7.7 E2E
│   ├── explore-tab.spec.ts            # 7.8 E2E
│   ├── landing-player.spec.ts         # 7.10 E2E
│   ├── theme-toggle.spec.ts           # 7.11 E2E
│   └── admin/
│       └── free-content.spec.ts       # 7.9 E2E
```

---

*Document generated by TEA (Test Engineering Architect)*
*Review and approve before implementation*
